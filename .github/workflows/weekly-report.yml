name: Weekly Market Report

on:
  schedule:
    # Run every Monday at 10:00 AM KST (01:00 UTC)
    - cron: '0 1 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Allow git push

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv sync
      
      - name: Install Firefox and geckodriver
        run: |
          sudo apt-get update -qq >/dev/null 2>&1
          sudo apt-get install -y firefox >/dev/null 2>&1 || true
          FIREFOX_PATH=$(find /snap/firefox -name firefox -type f -executable 2>/dev/null | head -1 || which firefox 2>/dev/null || echo "")
          if [ -n "${FIREFOX_PATH}" ]; then
            echo "FIREFOX_BINARY=${FIREFOX_PATH}" >> $GITHUB_ENV
            echo "âœ… Firefox: ${FIREFOX_PATH}"
          else
            echo "âš ï¸ Firefox not found"
          fi
          # Install geckodriver
          GECKODRIVER_VERSION="v0.36.0"
          wget -q https://github.com/mozilla/geckodriver/releases/download/${GECKODRIVER_VERSION}/geckodriver-${GECKODRIVER_VERSION}-linux64.tar.gz
          tar -xzf geckodriver-${GECKODRIVER_VERSION}-linux64.tar.gz
          chmod +x geckodriver
          sudo mv geckodriver /usr/local/bin/
          echo "âœ… geckodriver ${GECKODRIVER_VERSION} installed"

      - name: Create charts directory
        run: mkdir -p charts
      
      - name: Generate market report
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          DISPLAY: :99
        run: |
          set -e
          export PATH="$HOME/.local/bin:$PATH"
          cd ${{ github.workspace }}
          uv run python -m src.run_market_report > report_output.txt 2>&1 || {
            echo "âŒ Report generation failed!"
            cat report_output.txt
            exit 1
          }
          echo "âœ… Report generation successful"
          cat report_output.txt
      
      - name: Extract Notion URL
        id: extract_url
        run: |
          # Extract URL from dict: {'status': 'success', 'url': 'https://...', ...}
          NOTION_URL=$(grep -oP "'url':\s*'([^']+)'" report_output.txt | grep -oP "https://[^']+" | head -1)
          echo "notion_url=${NOTION_URL}" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Report URL: ${NOTION_URL}"
      
      - name: Update README
        if: steps.extract_url.outputs.notion_url != ''
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv run python scripts/update_readme.py "${{ steps.extract_url.outputs.notion_url }}"
      
      - name: Commit and push changes
        if: steps.extract_url.outputs.notion_url != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add readme.md data/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Weekly market report - $(date +'%Y-%m-%d')"
            git push origin HEAD:${{ github.ref_name }}
          fi

